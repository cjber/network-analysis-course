---
title: "Introduction to (Social) Network Analysis in R"
author: "Dr Griffith Rees"
date: "08/04/2020"
bibliography: references.bib
output:
  html_document:
    toc: true
    number_sections: true
    toc_float: true
    includes:
      before_body: doc_prefix.html
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require(igraph)) {
    install.packages("igraph", repos="http://cran.uk.r-project.org")
}
```

# (Social) Network Data

Today we're going to demonstrate simple ways of loading network data, visualisation, analysing structure, and showing how this can help answer research questions. 

First question (a poll): are you only interested in **social** networks like twitter [@murthySociologicalUnderstandingSocial2012] or could other types of networks be of interest [@teroRulesBiologicallyInspired2010]?

<iframe width="560" height="315" src="http://www.youtube.com/embed/GwKuFREOgmo?rel=0" frameborder="0" allowfullscreen></iframe>

## What is a Network?

A network is a way of representing how things are connected (or not). They can be social (who tweets to who), economic (which companies employ which people), engineering (which parts were used in each product) etc. The representing of these connetions is a network--also call a [graph](https://en.wikipedia.org/wiki/Graph_(discrete_mathematics)) in mathematics, (confusing eh?)--and in the social sciences it's a tool, often applied to help quantiatively (and sometimes qualitatively) answer research questions [@heathChasingShadowsDefining2009]. 

## Installing `R` and `igraph`

We're going to focus on the `igraph` `R` package today. There are [*many* other options](#na-packages) but `igraph` is a fairly comprehensive package for getting started. If you're looking to go beyond what we cover today, I recommend looking through the `igraph` documentation for your particular interests before trying the other packages, and feel free to email me [griffith.rees@sheffield.ac.uk](mailto:griffith.rees@sheffield.ac.uk) if you've got questions. Please ask *detailed* questions, demonstrating what you've trying to do and what you've tried so far so I can efficiently reply.

<!--Survey: Who's used R before?-->

<!--Survey: Who has a working R install?-->

<!--Survey: Who has a working igraph install? Let's just make sure that works for everyone.-->

For those that have got `igraph` installed feel free to continue further down this handout to play around with the data.

Everyone else: please download `RStudio` from <https://rstudio.com/products/rstudio/download/#download>.

It should fit your operating system automatically (Windows, Linux or Mac). If you're not seeing an option (possibly old versions of Windows, macOS, or unusual Linux distributions) message me. ^[Even if you're in a broader *nix category there are [options...](https://www.freshports.org/devel/RStudio/)]

<!--Survey: Finished installing R-->
Please fill in the survey when you're done or post messages if you're having issues.

Now let's install <https://igraph.org/r/>

```{r, eval=FALSE}
install.packages("igraph")
```

and then load it in your `R` session.

```{r, eval=FALSE}
library(igraph)
```

<!--Survey of people having completed this.-->

## Test `igraph` loading data

We're going to jump into visualisation with `igraph` as a test of the install and a demonstration of visualisation options. Then we'll break it down into what's going on underneath but again, feel free to mess around with what's loaded as we continue on.

We begin by loading node and edge data from [Dr Evelina Gabašová's](Dr Evelina Gabašová) excellent dataset on [which characters appeared together in scenes of star wars films](http://evelinag.com/blog/2015/12-15-star-wars-social-network/). Shamlessly borrowing from an NYU [short course](https://github.com/pablobarbera/data-science-workshop/tree/master/sna) created by [Dr Pablo Barberá's](http://pablobarbera.com/) we focus on Episode IV - *A New Hope*.

Have a look in the data folder and make sure there are 4 csv files, including `star-wars-network-edges.csv`  and `star-wars-network-nodes.csv` The originals can be found at <https://github.com/pablobarbera/data-science-workshop/tree/master/sna/data>. 

<!--Please download these datafiles:

* <https://github.com/pablobarbera/data-science-workshop/raw/master/sna/data/star-wars-network-edges.csv>
* <https://github.com/pablobarbera/data-science-workshop/raw/master/sna/data/star-wars-network-nodes.csv>
-->

### Load Node/Edge CSVs

In this dataset, nodes are characters in the film and edges are the number of scenes they appear in together.

```{r}
nodes <- read.csv("data/star-wars-network-nodes.csv")
nodes
edges <- read.csv("data/star-wars-network-edges.csv")
edges
```

There are many ways of storing network information, and we'll look at other options later. For now: note the nodes are the names of characters and the edges are pairs of characters followed by the number of scenes they share in the film.

### Creating a network

```{r}
g <- graph_from_data_frame(d=edges, vertices=nodes, directed=FALSE)
```

We'll look at how this works in detail in the next section, but note here that we load the `data frame` of edges into the `d` parameter and the `data frame` of nodes (in this characters) as vertices (another name for nodes in network analysis). We're setting `directed=FALSE` for simplicity (more on this later).

### Visualising a network

There are lots of ways to visualise networks. In part as a test of setup, we're jumping in to demonstrate how visualisation works and show make everything's installed correctly and the data is loading correctly as well.

```{r}
plot(g)
```

Mostly illegible eh? You're will have a different layout but as long as it looks similar we should be ready to go.

<!--Survey of this working for people.-->

Sneak preview of what's to come:

```{r, fig.width=12, fig.height=7, echo=FALSE}
# Prepare colour attribute
h <- g
dark_side <- c("DARTH VADER", "MOTTI", "TARKIN")
light_side <- c("R2-D2", "CHEWBACCA", "C-3PO", "LUKE", "CAMIE", "BIGGS",
                "LEIA", "BERU", "OWEN", "OBI-WAN", "HAN", "DODONNA",
                "GOLD LEADER", "WEDGE", "RED LEADER", "RED TEN", "GOLD FIVE")
other <- c("GREEDO", "JABBA")
# node we'll create a new color variable as a node property
V(h)$colour <- NA
V(h)$colour[V(h)$name %in% dark_side] <- "red"
V(h)$colour[V(h)$name %in% light_side] <- "gold"
V(h)$colour[V(h)$name %in% other] <- "grey20"

plot(h, layout=layout_with_fr, main="Force-directed")
legend(x=.75, y=.75, legend=c("Dark side", "Light side", "Other"), 
       pch=21, pt.bg=c("red", "gold", "grey20"), pt.cex=2, bty="n")
```


# Networks (aka *graphs*)

In this section we will be using a small network that indicates [interactions in the movie Star Wars Episode IV](http://evelinag.com/blog/2015/12-15-star-wars-social-network/). Available here: <https://github.com/pablobarbera/data-science-workshop>. Here, each node is a character and each edge indicates whether they appeared together in a scene of the movie. Edges here are thus _undirected_ and they also have weights attached, since they can appear in multiple scenes together.

The first step is to read the list of edges and nodes in this network:

```{r}
edges <- read.csv("data/star-wars-network-edges.csv")
head(edges)
nodes <- read.csv("data/star-wars-network-nodes.csv")
head(nodes)
```
For example, we learn that C-3PO and R2-D2 appeared in 17 scenes together.

How do we convert these two datasets into a network object in R? There are multiple packages to work with networks, but the most popular is `igraph` because it's very flexible and easy to do, and in my experience it's much faster and scales well to very large networks. Other packages that you may want to explore are `sna` and `networks`. We'll see an example later in this class, because some network modeling packages are not compatible with `igraph`.

Now, how do we create the igraph object? We can use the `graph_from_data_frame` function, which takes two arguments: `d`, the data frame with the edge list in the first two columns; and `vertices`, a data frame with node data with the node label in the first column. (Note that igraph calls the nodes `vertices`, but it's exactly the same thing.)

```{r, message=FALSE}
g <- graph_from_data_frame(d=edges, vertices=nodes, directed=FALSE)
g
```

What does it mean?

* `U` means undirected  
* `N` means named graph  
* `W` means weighted graph  
* `22` is the number of nodes  
* `60` is the number of edges  
* `name (v/c)` means _name_ is a node attribute and it's a character  
* `weight (e/n)` means _weight_ is an edge attribute and it's numeric  

This is how you access specific elements within the igraph object:

```{r}
V(g) # nodes
V(g)$name # names of each node
vertex_attr(g) # all attributes of the nodes
E(g) # edges
E(g)$weight # weights for each edge
edge_attr(g) # all attributes of the edges
g[] # adjacency matrix
g[1,] # first row of adjacency matrix
```


## Basic undirected network
```{r undirected, echo=FALSE, message=FALSE, warning=FALSE, }
g1 <- graph( edges=c("A","B", "B","C", "C", "A"), directed=FALSE ) 
plot(g1, vertex.size=100, vertex.label.cex=5, edge.width=5)
```

- A, B and C are *nodes* or *vertices* (people, companies, countries etc.)
- Connections are often called *ties* or *edges* (friendship, communication, contracts, kinship etc.)
- Undirected
$$A \ue B;B \ue C; C \ue A$$

## Advantages

* A way of representing a system (social, economic, digital, biological etc.)
* Can help explore and model
    + Properties [@wassermanSocialNetworkAnalysis1994]
    + Visualisations [@kerrenMultivariateNetworkVisualization2014]
    + Dynamics [@saavedraAsymmetricDisassemblyRobustness2008]
    + Simulations [@bearmanChainsAffectionStructure2004]
    
## Risks

* Complexity and size of data
* Sampling issues: **not law of large numbers** [@browneSnowballSamplingUsing2005]
* Pleathora of options
* Causal claims [@vanderweeleSocialNetworksCausal2013]
    
# Nodes

## Category, Type & Attribute
```{r types, echo=FALSE, message=FALSE, warning=FALSE, }
V(g1)[0:1]$color <- "green"
plot(g1, vertex.shape=c("circle", "square", "circle"), vertex.size=c(100, 100, 160), vertex.label.cex=5, edge.width=5)
```

- Category or group (club membership, kinship etc.)
- Type (employee, firm, region etc.)
- Attribute (age, ethnicity, size etc.)

## Structure of Romantic and Sexual Relations

<!--Could add bipartite here-->
* <https://github.com/pablobarbera/data-science-workshop/raw/master/sna/data/congress-twitter-network-edges.csv>
* <https://github.com/pablobarbera/data-science-workshop/raw/master/sna/data/congress-twitter-network-nodes.csv>

# Edges

## Direction, Weight & Type
```{r directed, echo=FALSE, message=FALSE, warning=FALSE, }
edge.scale <- c(7, 28, 3, 3, 5) 
arrow.scale <- edge.scale/1.2
g1 <- graph( edges=c("A","B", "B","C", "C", "A", "A", "C", "B", "B"), 
             directed=TRUE ) 
E(g1)$color <- c("blue", "red", "blue", "blue", "blue")
plot(g1, vertex.size=100,
     vertex.label.cex=5,
     edge.width=edge.scale,
     edge.arrow.size=arrow.scale
     )
```

- Direction (transaction, contract, message sender vs reciever etc.)
- Weight (amount of transaction, length of contract, frequency of message etc.)
- Type (type of transaction, cateory, texts vs tweets etc.)
- $A \de B; B \de C; C \leftrightarrow A; B \de B$

## Too impressive to be true?

<iframe width="560" height="315" src="http://www.youtube.com/embed/8aEtyRD1j5U?rel=0" frameborder="0" allowfullscreen></iframe>

## That's what lots have said[^1]...

- *Homophily and Contagion Are Generically Confounded in Observational Social Network Studies* [@shaliziHomophilyContagionAre2011]
- *The “unfriending” problem: The consequences of homophily in friendship retention for causal estimates of social influence* [@noelUnfriendingProblemConsequences2011]
- *Is obesity contagious? Social networks vs. environmental factors in the obesity epidemic* [@cohen-coleObesityContagiousSocial2008]
- *The spread of obesity in a large social network over 32 years* [@merckenDynamicsAdolescentFriendship2010][^2]
- ... and a reply: Christakis & Fowler [-@christakisSocialContagionTheory2013]

[^1]: See <https://statmodeling.stat.columbia.edu/2011/06/10/christakis-fowl/> for a summary
[^2]: Full disclosure: one of my examiners was a co-author on one of these papers...

# Types of Nodes 

Two types of Nodes (aka Bimodal or Bipartite Networks)

So far we've looked at nodes which vary in attributes (like name) but not in terms of types. A lot of work has been done on networks with 

## How to enforce different types of nodes


# What else?

## There's lots

- Negative ties (few studies but a recent [*Social Networks* special issue](https://www.sciencedirect.com/journal/social-networks/vol/60))
- [Erdős–Bacon number](https://en.wikipedia.org/wiki/Erd%C5%91s%E2%80%93Bacon_number)

## Useful links

* Most of this comes from/is inspired by Katherine Ognyanova's
  + [**Brilliant** visualisation guide](http://www.kateto.net/wp-content/uploads/2019/06/Sunbelt%202019%20R%20Network%20Visualization%20Workshop.pdf) 
  + Excellent github repo <https://github.com/kateto/R-Network-Visualization-Workshop>
* A bunch of useful links to papers/software etc. <https://github.com/briatte/awesome-network-analysis>
  
# Thanks

<!--## Another network time series...
![Network dynamics of creativity](collab_canvas.mov){ width=60% } -->
# Appendices

## Network Analysis Packages {#na-packages}

* R
    + [iGraph](https://igraph.org/r/) built on a C++ library, easier to get started and pre-dates ggplot so provides it's own visualisation options
    + [statnet](http://statnet.org/) focused particularly on [exponential random graphs (ERG) models](https://en.wikipedia.org/wiki/Exponential_random_graph_models), maintained by [Prof Carter T. Butts](https://scholar.google.co.uk/citations?user=-VGAs1cAAAAJ&hl=en)
    + [ggraph](https://ggraph.data-imaginist.com/) network visualisation in a way similar to [ggplot](https://ggplot2.tidyverse.org/reference/ggplot.html), maintained by [Thomas D Pedersen](https://www.data-imaginist.com/)
    + [Rsiena](https://www.stats.ox.ac.uk/~snijders/siena/) Actor-oriented logitudinal models (ERG), created by [Tom Snijders](https://cran.r-project.org/web/packages/RSiena/index.html)
* Python (my language of choice)
    + [networkx](https://networkx.github.io/) very old, not very fast but very flexible (my package of choice for ideas)
    + [igraph](https://igraph.org/python/) Effectively the same as the R package (both use the same underlying C++ library)
    + [graph-tool](https://graph-tool.skewed.de/) Much newer, very speed efficient (also C++ underneath)
* Windows
    + [UCINET](https://sites.google.com/site/ucinetsoftware/home) windows, developed and maintaied by (people including head of group at Manchester)

## References
